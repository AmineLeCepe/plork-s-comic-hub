<!doctype html>
<html lang="en">
<head>
    <title><%= (chapter && chapter.title) ? chapter.title : (comic ? comic.title : 'Read') %></title>
    <%- include("partials/head") %>
    <link rel="stylesheet" href="/css/read-comic.css">
</head>
<body>
<%- include("partials/navbar") %>
<div class="main-content">
    <%- include("partials/navbar2") %>

    <div class="reader-container">
        <header class="reader-header">
            <h1 class="reader-title">
                <%= comic ? comic.title : '' %><%= chapter && chapter.chapterNumber != null ? ` â€” Chapter ${chapter.chapterNumber}` : '' %>
            </h1>
            <% if (chapter && chapter.title) { %>
                <p class="reader-subtitle"><%= chapter.title %></p>
            <% } %>
        </header>

        <div class="page-list">
            <% if (chapter && Array.isArray(chapter.pages) && chapter.pages.length > 0) { %>
                <% chapter.pages.forEach(function(pageUrl, idx) { %>
                    <div class="page-row">
                        <img src="<%= pageUrl %>" alt="Page <%= idx + 1 %>" loading="lazy">
                    </div>
                <% }) %>
            <% } else { %>
                <p class="no-pages">No pages available for this chapter.</p>
            <% } %>
        </div>

        <!-- Comments Section -->
        <section class="comments-section">
            <h2 class="comments-title">Comments</h2>

            <div class="comment-form-wrap">
                <% if (typeof user !== 'undefined' && user) { %>
                    <% const remainingMs = typeof commentCooldownRemainingMs !== 'undefined' ? commentCooldownRemainingMs : 0; %>
                    <form class="comment-form" method="post" action="/comments" data-remaining-ms="<%= remainingMs %>">
                        <input type="hidden" name="chapterId" value="<%= chapter ? chapter._id : '' %>">
                        <input type="hidden" name="comicId" value="<%= comic ? comic._id : '' %>">
                        <textarea name="text" rows="3" placeholder="Write a comment..." maxlength="1000" required <%= remainingMs > 0 ? 'disabled' : '' %>></textarea>
                        <div class="comment-controls">
                            <button type="submit" class="comment-submit-btn" <%= remainingMs > 0 ? 'disabled' : '' %>>Post Comment</button>
                            <span id="comment-cooldown-hint" class="cooldown-hint" <%= remainingMs > 0 ? '' : 'style="visibility:hidden;"' %>></span>
                        </div>
                    </form>
                <% } else { %>
                    <div class="comment-login-hint">
                        <p>Please sign in to post a comment.</p>
                    </div>
                <% } %>
            </div>

            <div class="comments-list">
                <% if (Array.isArray(comments) && comments.length > 0) { %>
                    <% comments.forEach(function(cmt) { %>
                        <div class="comment-item">
                            <% 
                              const uname = (cmt.user && cmt.user.username) ? cmt.user.username : 'User';
                              // Map numeric pfp (1..8) to a static image path
                              const pfpNumRaw = (cmt.user && cmt.user.pfp != null) ? Number(cmt.user.pfp) : 1;
                              const pfpNum = (pfpNumRaw >= 1 && pfpNumRaw <= 8) ? pfpNumRaw : 1;
                              const avatarSrc = `/assets/avatars/default-${pfpNum}.png`;
                            %>
                            <img class="comment-avatar" src="<%= avatarSrc %>" alt="<%= uname %>" loading="lazy">
                            <div class="comment-header">
                                <div class="comment-author">
                                    <span class="comment-username"><%= uname %></span>
                                </div>
                                <time class="comment-time" datetime="<%= cmt.createdAt.toISOString ? cmt.createdAt.toISOString() : cmt.createdAt %>">
                                    <%= new Date(cmt.createdAt).toLocaleString() %>
                                </time>
                            </div>
                            <p class="comment-text"><%= cmt.text %></p>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p class="no-comments">No comments yet. Be the first comment!</p>
                <% } %>
            </div>
        </section>
        <!-- End Comments Section -->

        <script type="text/javascript">
          (function () {
            var form = document.querySelector('.comment-form');
            if (!form) return;
            var remaining = parseInt(form.getAttribute('data-remaining-ms') || '0', 10);
            var hint = document.getElementById('comment-cooldown-hint');
            var btn = form.querySelector('.comment-submit-btn');
            var textarea = form.querySelector('textarea');

            function format(ms) {
              var totalSec = Math.max(0, Math.floor(ms / 1000));
              var m = Math.floor(totalSec / 60);
              var s = totalSec % 60;
              return m + 'm ' + (s < 10 ? '0' : '') + s + 's';
            }

            function lockUI() {
              if (btn) btn.disabled = true;
              if (textarea) textarea.disabled = true;
              if (hint) {
                hint.style.visibility = 'visible';
                hint.textContent = 'You can comment in ' + format(remaining) + '.';
              }
            }

            function unlockUI() {
              if (btn) btn.disabled = false;
              if (textarea) textarea.disabled = false;
              if (hint) {
                hint.textContent = '';
                hint.style.visibility = 'hidden';
              }
            }

            if (remaining > 0) {
              lockUI();
              var interval = setInterval(function () {
                remaining -= 1000;
                if (remaining <= 0) {
                  clearInterval(interval);
                  unlockUI();
                  return;
                }
                if (hint) hint.textContent = 'You can comment in ' + format(remaining) + '.';
              }, 1000);
            }
          })();
        </script>
    </div>
</div>

<%- include("partials/scripts") %>
</body>
</html>