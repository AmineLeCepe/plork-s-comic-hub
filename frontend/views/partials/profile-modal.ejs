<div id="profileModal" class="profile-modal">

    <%# The error display is now inside the modal's logged-out view %>

    <% if (user) { %>
        <%# --- LOGGED-IN STATE --- %>
        <div class="modal-content">
            <div class="modal-header">
                <div class="user-info">
                    <img src="/assets/default-avatar.png" alt="Profile" class="modal-profile-img"/>
                    <div class="user-details">
                        <h3 class="username"><%= user.username %></h3>
                        <span class="user-status">Member since <%= user.createdAt.getFullYear() %></span>
                    </div>
                </div>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <ul class="profile-menu">
                    <li class="profile-menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <a href="/profile">My Profile</a>
                    </li>
                    <li class="profile-menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                        <a href="/bookmarks">My Bookmarks</a>
                    </li>
                    <li class="profile-menu-item">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                        <a href="/reading-history">Reading History</a>
                    </li>
                    <% if (user.roles.isAdmin) { %>
                        <li class="profile-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z m8 2h2v6h-2V5z m0 8h2v2h-2v-2z"></path></svg>
                            <a href="/admin">Admin Panel</a>
                        </li>
                    <% } %>
                    <% if (user.roles.isAdmin || user.roles.isAuthor) { %>
                        <li class="profile-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6" y2="6"></line><line x1="6" y1="18" x2="6" y2="18"></line></svg>
                            <a href="/manage-uploads">Manage Uploads</a>
                        </li>
                    <% } %>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="sign-out-btn" onclick="window.location.href='/logout'">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Sign Out
                </button>
            </div>
        </div>

    <% } else { %>
        <%# --- LOGGED-OUT STATE --- %>
        <div class="modal-content logged-out">
            <div class="modal-header">
                <h3 class="username">Sign In</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <% if (error && error.length > 0) { %>
                    <div class="alert-error" style="color: red; padding-bottom: 12px; text-align: center; font-weight: 500;">
                        <%= error %>
                    </div>
                <% } %>
                <form action="/login" method="POST" class="modal-login-form">
                    <div class="form-group">
                        <label for="modal-username">Username</label>
                        <input type="text" id="modal-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-password">Password</label>
                        <input type="password" id="modal-password" name="password" required>
                    </div>
                    <button type="submit" class="auth-button">Log In</button>
                </form>
            </div>
            <div class="modal-footer">
                <a href="/forgot-password">Forgot password?</a>
            </div>
            <div class="modal-footer">
                <a href="/signup">Not a user? Register</a>
            </div>
        </div>
    <% } %>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const modal = document.getElementById("profileModal");
        if (!modal) return;

        const profileIcon = document.getElementById("profileIcon");
        const closeBtns = document.getElementsByClassName("close-modal");

        function positionModal() {
            if (!profileIcon) return;
            const profileRect = profileIcon.getBoundingClientRect();
            const modalContent = modal.querySelector(".modal-content");
            if (!modalContent) return;

            const top = profileRect.bottom + window.scrollY + 10;
            const right = window.innerWidth - profileRect.right;

            modalContent.style.top = `${top}px`;
            modalContent.style.right = `${right}px`;
        }

        function openModal() {
            positionModal();
            modal.style.display = "block";
            setTimeout(() => modal.classList.add("active"), 10);
        }

        if (profileIcon) {
            profileIcon.onclick = openModal;
        }

        for (let i = 0; i < closeBtns.length; i++) {
            closeBtns[i].onclick = function() {
                modal.classList.remove("active");
                setTimeout(() => modal.style.display = "none", 300);
            }
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.classList.remove("active");
                setTimeout(() => modal.style.display = "none", 300);
            }
        }

        window.addEventListener('resize', function() {
            if (modal.style.display === "block") {
                positionModal();
            }
        });

        // If an error message exists, open the modal automatically
        const hasError = <%= (typeof error !== 'undefined' && error.length > 0) ? 'true' : 'false' %>;
        if (hasError) {
            openModal();
        }
    });
</script>